name: Multi-Environment CI/CD Pipeline

on:
  push:
    branches: [main, qa, develop]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options: [dev, qa, prod]

jobs:
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      run-sonarqube: ${{ steps.set-env.outputs.run-sonarqube }}
    
    steps:
      - name: Determine Environment
        id: set-env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            ENV="prod"
          elif [[ "${{ github.ref }}" == "refs/heads/qa" ]]; then
            ENV="qa"
          else
            ENV="dev"
          fi
          
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "run-sonarqube=$([[ $ENV == 'dev' ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

  quality:
    needs: setup
    uses: ./.github/workflows/quality-checks.yml
    secrets: inherit
    with:
      environment: ${{ needs.setup.outputs.environment }}
      run-sonarqube: ${{ needs.setup.outputs.run-sonarqube }}

  deploy:
    needs: [setup, quality]
    uses: ./.github/workflows/deploy.yml
    with:
      environment: ${{ needs.setup.outputs.environment }}

  security:
    needs: [setup, deploy]
    uses: ./.github/workflows/security-tests.yml
    with:
      environment: ${{ needs.setup.outputs.environment }}

  performance:
    needs: [setup, deploy]
    uses: ./.github/workflows/performance-tests.yml
    with:
      environment: ${{ needs.setup.outputs.environment }}

  summary:
    name: Pipeline Summary
    needs: [setup, quality, deploy, security, performance]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - run: |
          echo "# ðŸŽ¯ Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "Environment: **${{ needs.setup.outputs.environment }}**" >> $GITHUB_STEP_SUMMARY
          echo "- Quality Checks: ${{ needs.quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Deploy: ${{ needs.deploy.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Tests: ${{ needs.security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Performance Tests: ${{ needs.performance.result }}" >> $GITHUB_STEP_SUMMARY