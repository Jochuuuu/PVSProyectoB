name: Multi-Environment CI/CD Pipeline

on:
  push:
    branches:
      - main      # PROD environment
      - qa        # QA environment
      - develop   # DEV environment
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - qa
          - prod

jobs:
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      run-sonarqube: ${{ steps.set-env.outputs.run-sonarqube }}
      run-jmeter: ${{ steps.set-env.outputs.run-jmeter }}
    
    steps:
      - name: Determine Environment
        id: set-env
        run: |
          # Detect environment from branch or manual input
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            ENV="prod"
          elif [[ "${{ github.ref }}" == "refs/heads/qa" ]]; then
            ENV="qa"
          else
            ENV="dev"
          fi
          
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "ðŸš€ Environment detected: $ENV"
          
          # Set conditional flags based on environment
          if [[ "$ENV" == "dev" ]]; then
            echo "run-sonarqube=true" >> $GITHUB_OUTPUT
            echo "run-jmeter=true" >> $GITHUB_OUTPUT
          elif [[ "$ENV" == "qa" ]]; then
            echo "run-sonarqube=false" >> $GITHUB_OUTPUT
            echo "run-jmeter=true" >> $GITHUB_OUTPUT
          else
            echo "run-sonarqube=false" >> $GITHUB_OUTPUT
            echo "run-jmeter=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Show Environment Configuration
        run: |
          echo "================================"
          echo "ðŸŒ Environment: ${{ steps.set-env.outputs.environment }}"
          echo "ðŸ“Š Run SonarQube: ${{ steps.set-env.outputs.run-sonarqube }}"
          echo "âš¡ Run JMeter: ${{ steps.set-env.outputs.run-jmeter }}"
          echo "================================"

  build-and-test:
    name: Build and Unit Tests
    needs: setup
    runs-on: ubuntu-latest
    env:
      ENVIRONMENT: ${{ needs.setup.outputs.environment }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true

      - name: Run Unit Tests (pytest)
        run: |
          echo "ðŸ§ª Running tests in $ENVIRONMENT environment"
          pytest --cov=. --cov-report=xml --cov-report=term-missing --ignore=tests/test_login_selenium.py
        continue-on-error: false

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ env.ENVIRONMENT }}
          path: coverage.xml

  sonarqube-analysis:
    name: SonarQube Analysis (DEV only)
    needs: [setup, build-and-test]
    runs-on: ubuntu-latest
    if: needs.setup.outputs.run-sonarqube == 'true'
    env:
      ENVIRONMENT: ${{ needs.setup.outputs.environment }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Coverage Report
        uses: actions/download-artifact@v4
        with:
          name: coverage-report-${{ env.ENVIRONMENT }}

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      - name: SonarQube Quality Gate Check
        uses: SonarSource/sonarqube-quality-gate-action@v1
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        timeout-minutes: 5

  deploy-backend:
    name: Deploy Backend
    needs: [setup, build-and-test]
    runs-on: ubuntu-latest
    env:
      ENVIRONMENT: ${{ needs.setup.outputs.environment }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install System Dependencies for rtree
        run: |
          echo "ðŸ“¦ Installing system dependencies for rtree..."
          sudo apt-get update
          sudo apt-get install -y libspatialindex-dev
          echo "âœ… System dependencies installed"
      
      - name: Install Python Dependencies
        run: |
          echo "ðŸ Installing Python dependencies..."
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          echo "âœ… All Python dependencies installed"
      
      - name: Verify rtree Installation
        run: |
          echo "ðŸ” Verifying rtree installation..."
          python -c "from rtree import index; print('âœ… rtree imported successfully')"
          pip show rtree

      - name: Set Environment Variables
        run: |
          # Set different configs per environment
          if [[ "$ENVIRONMENT" == "prod" ]]; then
            echo "PORT=8000" >> $GITHUB_ENV
            echo "HOST=0.0.0.0" >> $GITHUB_ENV
          elif [[ "$ENVIRONMENT" == "qa" ]]; then
            echo "PORT=8001" >> $GITHUB_ENV
            echo "HOST=0.0.0.0" >> $GITHUB_ENV
          else
            echo "PORT=8002" >> $GITHUB_ENV
            echo "HOST=0.0.0.0" >> $GITHUB_ENV
          fi

      - name: Start FastAPI Backend and Health Check
        run: |
          echo "ðŸš€ Starting backend in $ENVIRONMENT environment on port $PORT"
          nohup uvicorn main:app --host $HOST --port $PORT > backend-$ENVIRONMENT.log 2>&1 &
          BACKEND_PID=$!
          echo "Backend PID: $BACKEND_PID"
          
          # Wait for backend to start (max 30 seconds)
          echo "â³ Waiting for backend to be ready..."
          for i in {1..30}; do
            if curl -s http://localhost:$PORT/health > /dev/null 2>&1; then
              echo "âœ… Backend is ready after $i seconds"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "âŒ Backend failed to start after 30 seconds"
              echo "ðŸ“‹ Backend logs:"
              cat backend-$ENVIRONMENT.log
              exit 1
            fi
            sleep 1
          done
          
          # Final health check
          echo "ðŸ¥ Performing health check on $ENVIRONMENT environment"
          if curl -f http://localhost:$PORT/health; then
            echo "âœ… Health check passed"
          else
            echo "âŒ Health check failed"
            echo "ðŸ“‹ Backend logs:"
            cat backend-$ENVIRONMENT.log
            exit 1
          fi

      - name: Upload Backend Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-logs-${{ env.ENVIRONMENT }}
          path: backend-${{ env.ENVIRONMENT }}.log

  jmeter-tests:
    name: JMeter Performance Tests
    needs: [setup, deploy-backend]
    runs-on: ubuntu-latest
    if: needs.setup.outputs.run-jmeter == 'true'
    env:
      ENVIRONMENT: ${{ needs.setup.outputs.environment }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install System Dependencies for Backend
        run: |
          echo "ðŸ“¦ Installing system dependencies..."
          sudo apt-get update
          sudo apt-get install -y libspatialindex-dev
          
      - name: Install and Start Backend
        run: |
          echo "ðŸ Installing all Python dependencies..."
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
          echo "ðŸ” Verifying rtree..."
          python -c "from rtree import index; print('âœ… rtree OK')"
          
          # Set port based on environment
          if [[ "$ENVIRONMENT" == "prod" ]]; then
            PORT=8000
          elif [[ "$ENVIRONMENT" == "qa" ]]; then
            PORT=8001
          else
            PORT=8002
          fi
          
          echo "ðŸš€ Starting backend on port $PORT"
          nohup uvicorn main:app --host 0.0.0.0 --port $PORT > backend.log 2>&1 &
          sleep 15
          
          echo "âœ… Backend started, checking if running..."
          curl -v http://localhost:$PORT/health || cat backend.log

      - name: Setup JMeter 5.6.3
        run: |
          echo "ðŸ“¦ Installing JMeter for $ENVIRONMENT environment"
          wget -q https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.3.tgz
          tar -xzf apache-jmeter-5.6.3.tgz
          export PATH="$(pwd)/apache-jmeter-5.6.3/bin:$PATH"
          jmeter --version

      - name: Run JMeter Performance Tests
        run: |
          export PATH="$(pwd)/apache-jmeter-5.6.3/bin:$PATH"
          
          # Set different load profiles per environment
          if [[ "$ENVIRONMENT" == "prod" ]]; then
            THREADS=50
            RAMP_UP=30
          elif [[ "$ENVIRONMENT" == "qa" ]]; then
            THREADS=30
            RAMP_UP=20
          else
            THREADS=10
            RAMP_UP=10
          fi
          
          echo "âš¡ Running JMeter tests in $ENVIRONMENT with $THREADS threads"
          jmeter -n -t tests/jmeter/backend-test.jmx \
            -l jmeter-results-$ENVIRONMENT.jtl \
            -JBASE_URL=localhost \
            -JThreads=$THREADS \
            -JRampUp=$RAMP_UP
          
          jmeter -g jmeter-results-$ENVIRONMENT.jtl -o jmeter-report-$ENVIRONMENT

      - name: Upload JMeter HTML Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-html-report-${{ env.ENVIRONMENT }}
          path: jmeter-report-${{ env.ENVIRONMENT }}/

      - name: Upload JMeter Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-results-${{ env.ENVIRONMENT }}
          path: jmeter-results-${{ env.ENVIRONMENT }}.jtl

      - name: Show Backend Logs (if failed)
        if: failure()
        run: cat backend.log

  summary:
    name: Pipeline Summary
    needs: [setup, build-and-test, sonarqube-analysis, deploy-backend, jmeter-tests]
    runs-on: ubuntu-latest
    if: always()
    env:
      ENVIRONMENT: ${{ needs.setup.outputs.environment }}
    
    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸŽ¯ Pipeline Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Environment: **$ENVIRONMENT**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Stages Executed:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Build and Unit Tests" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.setup.outputs.run-sonarqube }}" == "true" ]]; then
            echo "- âœ… SonarQube Analysis (DEV only)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- â­ï¸ SonarQube Analysis (Skipped - Not DEV)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "- âœ… Backend Deployment" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… JMeter Performance Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Results:" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ needs.build-and-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- SonarQube: ${{ needs.sonarqube-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Deploy: ${{ needs.deploy-backend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- JMeter: ${{ needs.jmeter-tests.result }}" >> $GITHUB_STEP_SUMMARY