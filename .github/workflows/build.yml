name: Multi-Environment CI/CD Pipeline

on:
  push:
    branches:
      - main      # PROD environment
      - qa        # QA environment
      - develop   # DEV environment
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - qa
          - prod

jobs:
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      run-sonarqube: ${{ steps.set-env.outputs.run-sonarqube }}
      run-jmeter: ${{ steps.set-env.outputs.run-jmeter }}
    
    steps:
      - name: Determine Environment
        id: set-env
        run: |
          # Detect environment from branch or manual input
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            ENV="prod"
          elif [[ "${{ github.ref }}" == "refs/heads/qa" ]]; then
            ENV="qa"
          else
            ENV="dev"
          fi
          
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "ðŸš€ Environment detected: $ENV"
          
          # Set conditional flags based on environment
          if [[ "$ENV" == "dev" ]]; then
            echo "run-sonarqube=true" >> $GITHUB_OUTPUT
            echo "run-jmeter=true" >> $GITHUB_OUTPUT
          elif [[ "$ENV" == "qa" ]]; then
            echo "run-sonarqube=false" >> $GITHUB_OUTPUT
            echo "run-jmeter=true" >> $GITHUB_OUTPUT
          else
            echo "run-sonarqube=false" >> $GITHUB_OUTPUT
            echo "run-jmeter=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Show Environment Configuration
        run: |
          echo "================================"
          echo "ðŸŒ Environment: ${{ steps.set-env.outputs.environment }}"
          echo "ðŸ“Š Run SonarQube: ${{ steps.set-env.outputs.run-sonarqube }}"
          echo "âš¡ Run JMeter: ${{ steps.set-env.outputs.run-jmeter }}"
          echo "================================"

  build-and-test:
    name: Build and Unit Tests
    needs: setup
    runs-on: ubuntu-latest
    env:
      ENVIRONMENT: ${{ needs.setup.outputs.environment }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true

      - name: Run Unit Tests (pytest)
        run: |
          echo "ðŸ§ª Running tests in $ENVIRONMENT environment"
          pytest --cov=. --cov-report=xml --cov-report=term-missing --ignore=tests/test_login_selenium.py
        continue-on-error: false

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ env.ENVIRONMENT }}
          path: coverage.xml

  sonarqube-analysis:
    name: SonarQube Analysis (DEV only)
    needs: [setup, build-and-test]
    runs-on: ubuntu-latest
    if: needs.setup.outputs.run-sonarqube == 'true'
    env:
      ENVIRONMENT: ${{ needs.setup.outputs.environment }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Coverage Report
        uses: actions/download-artifact@v4
        with:
          name: coverage-report-${{ env.ENVIRONMENT }}

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      - name: SonarQube Quality Gate Check
        uses: SonarSource/sonarqube-quality-gate-action@v1
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        timeout-minutes: 5

      - name: Start FastAPI backend
        run: |
          pip install fastapi uvicorn bcrypt pyjwt
          nohup uvicorn main:app --host 0.0.0.0 --port 8000 > backend.log 2>&1 &
          sleep 15
          curl -v http://localhost:8000/ || cat backend.log

        
        
      - name: Setup JMeter 5.6.3
        run: |
          echo "ðŸ“¦ Installing JMeter for $ENVIRONMENT environment"
          wget -q https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.3.tgz
          tar -xzf apache-jmeter-5.6.3.tgz
          export PATH="$(pwd)/apache-jmeter-5.6.3/bin:$PATH"
          jmeter --version

      - name: Run JMeter Performance Tests
        run: |
          export PATH="$(pwd)/apache-jmeter-5.6.3/bin:$PATH"
          
          # Set different load profiles per environment
          if [[ "$ENVIRONMENT" == "prod" ]]; then
            THREADS=50
            RAMP_UP=30
          elif [[ "$ENVIRONMENT" == "qa" ]]; then
            THREADS=30
            RAMP_UP=20
          else
            THREADS=10
            RAMP_UP=10
          fi
          
          echo "âš¡ Running JMeter tests in $ENVIRONMENT with $THREADS threads"
          jmeter -n -t tests/jmeter/backend-test.jmx \
            -l jmeter-results-$ENVIRONMENT.jtl \
            -JBASE_URL=localhost \
            -JThreads=$THREADS \
            -JRampUp=$RAMP_UP
          
          jmeter -g jmeter-results-$ENVIRONMENT.jtl -o jmeter-report-$ENVIRONMENT

      - name: Upload JMeter HTML Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-html-report-${{ env.ENVIRONMENT }}
          path: jmeter-report-${{ env.ENVIRONMENT }}/

      - name: Upload JMeter Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-results-${{ env.ENVIRONMENT }}
          path: jmeter-results-${{ env.ENVIRONMENT }}.jtl

      - name: Show Backend Logs (if failed)
        if: failure()
        run: cat backend.log

  summary:
    name: Pipeline Summary
    needs: [setup, build-and-test, sonarqube-analysis, deploy-backend, jmeter-tests]
    runs-on: ubuntu-latest
    if: always()
    env:
      ENVIRONMENT: ${{ needs.setup.outputs.environment }}
    
    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸŽ¯ Pipeline Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Environment: **$ENVIRONMENT**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Stages Executed:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Build and Unit Tests" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.setup.outputs.run-sonarqube }}" == "true" ]]; then
            echo "- âœ… SonarQube Analysis (DEV only)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- â­ï¸ SonarQube Analysis (Skipped - Not DEV)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "- âœ… Backend Deployment" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… JMeter Performance Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Results:" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ needs.build-and-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- SonarQube: ${{ needs.sonarqube-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Deploy: ${{ needs.deploy-backend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- JMeter: ${{ needs.jmeter-tests.result }}" >> $GITHUB_STEP_SUMMARY